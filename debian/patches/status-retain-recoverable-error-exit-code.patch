Description: Retain exit code in cloud-init status for recoverable errors
 (LP: #2048522).
Author: Alberto Contreras <alberto.contreras@canonical.com>
Last-Update: 2024-01-08
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
--- a/cloudinit/cmd/status.py
+++ b/cloudinit/cmd/status.py
@@ -254,7 +254,7 @@ def handle_status_args(name, args) -> in
         return 1
     # Recoverable error
     elif details.condition_status == ConditionStatus.DEGRADED:
-        return 2
+        return 0
     return 0
 
 
--- a/tests/unittests/cmd/test_status.py
+++ b/tests/unittests/cmd/test_status.py
@@ -523,7 +523,7 @@ PATH=/usr/local/sbin:/usr/local/bin:/usr
                    recoverable_errors: {}
                    schemas:
                        '1':
-                           boot_status_code: enabled-by-kernel-cmdline
+                           boot_status_code: enabled-by-kernel-command-line
                            datasource: ''
                            detail: 'Running in stage: init'
                            errors: []
@@ -573,7 +573,7 @@ PATH=/usr/local/sbin:/usr/local/bin:/usr
                     "_schema_version": "1",
                     "schemas": {
                         "1": {
-                            "boot_status_code": "enabled-by-kernel-cmdline",
+                            "boot_status_code": "enabled-by-kernel-command-line",
                             "datasource": "",
                             "detail": "Running in stage: init",
                             "errors": [],
@@ -644,7 +644,7 @@ PATH=/usr/local/sbin:/usr/local/bin:/usr
                     "recoverable_errors": {},
                     "schemas": {
                         "1": {
-                            "boot_status_code": "enabled-by-kernel-cmdline",
+                            "boot_status_code": "enabled-by-kernel-command-line",
                             "datasource": "nocloud",
                             "detail": "DataSourceNoCloud "
                             "[seed=/var/.../seed/nocloud-net][dsmode=net]",
@@ -726,7 +726,7 @@ PATH=/usr/local/sbin:/usr/local/bin:/usr
                 },
                 None,
                 MyArgs(long=False, wait=False, format="json"),
-                2,
+                0,
                 {
                     "_schema_version": "1",
                     "boot_status_code": "enabled-by-kernel-command-line",
@@ -790,7 +790,7 @@ PATH=/usr/local/sbin:/usr/local/bin:/usr
                     },
                     "schemas": {
                         "1": {
-                            "boot_status_code": "enabled-by-kernel-cmdline",
+                            "boot_status_code": "enabled-by-kernel-command-line",
                             "datasource": "nocloud",
                             "detail": "DataSourceNoCloud "
                             "[seed=/var/.../seed/nocloud-net][dsmode=net]",
